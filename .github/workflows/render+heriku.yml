name: Heroku + Render Deploy
on: [push]

# Set minimal permissions at workflow level (least privilege principle)
permissions:
  contents: read

jobs:
  # First job: detect which parts have changed
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo contents for checkout and path filtering
    outputs:
      backend: ${{ steps.filter.outputs.backend || steps.check-commit-msg.outputs.force_deploy == 'true' }}
      terminal: ${{ steps.filter.outputs.terminal || steps.check-commit-msg.outputs.force_deploy == 'true' }}
      frontend: ${{ steps.filter.outputs.frontend || steps.check-commit-msg.outputs.force_deploy == 'true' }}
      shared: ${{ steps.filter.outputs.shared }}
      force_deploy: ${{ steps.check-commit-msg.outputs.force_deploy }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      
      # Check if commit message contains force deploy flag
      - name: Check commit message
        id: check-commit-msg
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q "\[deploy-all\]" || echo "$COMMIT_MSG" | grep -q "\[force-deploy\]"; then
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "Force deployment detected from commit message"
          else
            echo "force_deploy=false" >> $GITHUB_OUTPUT
          fi
      
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            backend:
              - 'portfolio_api/**'
              - 'docker-compose.yml'
              - 'nginx.conf'
            terminal:
              - 'portfolio-terminal/**'  
            frontend:
              - 'portfolio_ui/**'
            shared:
              - 'docker-compose.yml'
              - 'nginx.conf'

      - name: Report changes
        run: |
          echo "Backend changes: ${{ steps.filter.outputs.backend }}"
          echo "Terminal changes: ${{ steps.filter.outputs.terminal }}"
          echo "Frontend changes: ${{ steps.filter.outputs.frontend }}"
          echo "Shared config changes: ${{ steps.filter.outputs.shared }}"
          echo "Force deploy: ${{ steps.check-commit-msg.outputs.force_deploy }}"

  # Backend deployment job with condition
  deploy-backend:
    needs: [check-changes]
    if: |
      (needs.check-changes.outputs.backend == 'true' || needs.check-changes.outputs.shared == 'true' || needs.check-changes.outputs.force_deploy == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo for checkout
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Check if Dependabot PR
        id: check-dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dependabot PR detected - skipping actual deployment"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy reason
        run: |
          if [[ "${{ needs.check-changes.outputs.force_deploy }}" == "true" ]]; then
            echo "ðŸš€ Deploying backend because force deploy was requested in commit message"
          else
            echo "ðŸš€ Deploying backend because backend files changed"
          fi

      - name: Update Render Environment Variables
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: |
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "envVars": [
              {"key": "SMTP_USER", "value": "${{ secrets.SMTP_USER }}"},
              {"key": "SMTP_PASSWORD", "value": "${{ secrets.SMTP_PASSWORD }}"}
            ]
          }' \
          https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/env-vars
              
      - name: Render Deploy Action
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        uses: johnbeynon/render-deploy-action@a0588f9aca995a15d69a72cb2bfbf37c12e5b540 # v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          
      - name: Run Migrations and Import Data
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: |
          # First deployment to create service
          curl -X POST -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
               https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploy
          
          # Wait for service to be ready
          sleep 120
          
          # Run migrations
          curl -X POST -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
               -H "Content-Type: application/json" \
               -d '{"clearCache": "do_not_clear"}' \
               https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploy
      
      - name: Dependabot PR Check Passed
        if: steps.check-dependabot.outputs.is_dependabot == 'true'
        run: |
          echo "âœ… Dependabot PR validated - deployment skipped intentionally"
          echo "This PR can be safely merged if all other checks pass"

  # Frontend deployment job with condition
  deploy-frontend:
    needs: [check-changes]
    if: |
      (needs.check-changes.outputs.frontend == 'true' || needs.check-changes.outputs.force_deploy == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo for checkout
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Check if Dependabot PR
        id: check-dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dependabot PR detected - skipping actual deployment"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy reason
        run: |
          if [[ "${{ needs.check-changes.outputs.force_deploy }}" == "true" ]]; then
            echo "ðŸš€ Deploying frontend because force deploy was requested in commit message"
          else
            echo "ðŸš€ Deploying frontend because frontend files changed"
          fi
      
      - name: Install Heroku CLI
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: curl https://cli-assets.heroku.com/install.sh | sh
      
      # Set Heroku stack to container
      - name: Set Heroku stack to container
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: heroku stack:set container -a portfolio-frontend
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      
      - name: Build, Push and Release a Docker container to Heroku
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        uses: gonuit/heroku-docker-deploy@9ab97585f979857642d66612a2ae4062b3347d53 # v1.3.3
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "portfolio-frontend"
          email: "a.ouichou@student.42.fr" 
          dockerfile_directory: "./portfolio_ui/"
      
      - name: Dependabot PR Check Passed
        if: steps.check-dependabot.outputs.is_dependabot == 'true'
        run: |
          echo "âœ… Dependabot PR validated - deployment skipped intentionally"
          echo "This PR can be safely merged if all other checks pass"

  # Terminal service deployment job
  deploy-terminal:
    needs: [check-changes]
    if: |
      (needs.check-changes.outputs.terminal == 'true' || needs.check-changes.outputs.shared == 'true' || needs.check-changes.outputs.force_deploy == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo for checkout
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Check if Dependabot PR
        id: check-dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dependabot PR detected - skipping actual deployment"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy reason
        run: |
          if [[ "${{ needs.check-changes.outputs.force_deploy }}" == "true" ]]; then
            echo "ðŸš€ Deploying terminal service because force deploy was requested"
          elif [[ "${{ needs.check-changes.outputs.shared }}" == "true" ]]; then
            echo "ðŸš€ Deploying terminal service because shared configs changed"
          else
            echo "ðŸš€ Deploying terminal service because terminal files changed"
          fi

      - name: Render Deploy Action for Terminal Service
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        uses: johnbeynon/render-deploy-action@a0588f9aca995a15d69a72cb2bfbf37c12e5b540 # v0.0.8
        with:
          service-id: ${{ secrets.RENDER_TERMINAL_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
      
      - name: Dependabot PR Check Passed
        if: steps.check-dependabot.outputs.is_dependabot == 'true'
        run: |
          echo "âœ… Dependabot PR validated - deployment skipped intentionally"
          echo "This PR can be safely merged if all other checks pass"
name: Heroku + DigitalOcean Deploy
on:
  push:
    branches:
      - main

# Set minimal permissions at workflow level (least privilege principle)
permissions:
  contents: read

jobs:
  # First job: detect which parts have changed
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo contents for checkout and path filtering
    outputs:
      backend: ${{ steps.filter.outputs.backend || steps.check-commit-msg.outputs.force_deploy == 'true' }}
      terminal: ${{ steps.filter.outputs.terminal || steps.check-commit-msg.outputs.force_deploy == 'true' }}
      frontend: ${{ steps.filter.outputs.frontend || steps.check-commit-msg.outputs.force_deploy == 'true' }}
      shared: ${{ steps.filter.outputs.shared }}
      force_deploy: ${{ steps.check-commit-msg.outputs.force_deploy }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
      
      # Check if commit message contains force deploy flag
      - name: Check commit message
        id: check-commit-msg
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q "\[deploy-all\]" || echo "$COMMIT_MSG" | grep -q "\[force-deploy\]"; then
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "Force deployment detected from commit message"
          else
            echo "force_deploy=false" >> $GITHUB_OUTPUT
          fi
      
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            backend:
              - 'portfolio_api/**'
              - 'docker-compose.yml'
              - 'nginx.conf'
            terminal:
              - 'portfolio-terminal/**'  
            frontend:
              - 'portfolio_ui/**'
            shared:
              - 'docker-compose.yml'
              - 'nginx.conf'

      - name: Report changes
        run: |
          echo "Backend changes: ${{ steps.filter.outputs.backend }}"
          echo "Terminal changes: ${{ steps.filter.outputs.terminal }}"
          echo "Frontend changes: ${{ steps.filter.outputs.frontend }}"
          echo "Shared config changes: ${{ steps.filter.outputs.shared }}"
          echo "Force deploy: ${{ steps.check-commit-msg.outputs.force_deploy }}"

  # Backend deployment job - DigitalOcean App Platform
  deploy-backend:
    needs: [check-changes]
    if: |
      (needs.check-changes.outputs.backend == 'true' || needs.check-changes.outputs.shared == 'true' || needs.check-changes.outputs.force_deploy == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo for checkout
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Check if Dependabot PR
        id: check-dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dependabot PR detected - skipping actual deployment"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy reason
        run: |
          if [[ "${{ needs.check-changes.outputs.force_deploy }}" == "true" ]]; then
            echo "üöÄ Deploying backend to DigitalOcean because force deploy was requested"
          else
            echo "üöÄ Deploying backend to DigitalOcean because backend files changed"
          fi

      - name: Trigger DigitalOcean Deployment
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/${{ secrets.DIGITALOCEAN_APP_ID }}/deployments
      
      - name: Wait for Deployment
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: |
          echo "‚è≥ Waiting for DigitalOcean deployment to complete (2-3 minutes)..."
          sleep 180
          echo "‚úÖ Deployment should be complete. Check DigitalOcean dashboard for status."
      
      - name: Dependabot PR Check Passed
        if: steps.check-dependabot.outputs.is_dependabot == 'true'
        run: |
          echo "‚úÖ Dependabot PR validated - deployment skipped intentionally"
          echo "This PR can be safely merged if all other checks pass"

  # Frontend deployment job with condition
  deploy-frontend:
    needs: [check-changes]
    if: |
      (needs.check-changes.outputs.frontend == 'true' || needs.check-changes.outputs.force_deploy == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo for checkout
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Check if Dependabot PR
        id: check-dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dependabot PR detected - skipping actual deployment"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy reason
        run: |
          if [[ "${{ needs.check-changes.outputs.force_deploy }}" == "true" ]]; then
            echo "üöÄ Deploying frontend because force deploy was requested in commit message"
          else
            echo "üöÄ Deploying frontend because frontend files changed"
          fi
      
      - name: Install Heroku CLI
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: curl https://cli-assets.heroku.com/install.sh | sh
      
      # Set Heroku stack to container
      - name: Set Heroku stack to container
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: heroku stack:set container -a portfolio-frontend
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      
      - name: Build, Push and Release a Docker container to Heroku
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        uses: gonuit/heroku-docker-deploy@9ab97585f979857642d66612a2ae4062b3347d53 # v1.3.3
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "portfolio-frontend"
          email: "a.ouichou@student.42.fr" 
          dockerfile_directory: "./portfolio_ui/"
      
      - name: Dependabot PR Check Passed
        if: steps.check-dependabot.outputs.is_dependabot == 'true'
        run: |
          echo "‚úÖ Dependabot PR validated - deployment skipped intentionally"
          echo "This PR can be safely merged if all other checks pass"

  # Terminal service deployment job - DigitalOcean App Platform
  deploy-terminal:
    needs: [check-changes]
    if: |
      (needs.check-changes.outputs.terminal == 'true' || needs.check-changes.outputs.shared == 'true' || needs.check-changes.outputs.force_deploy == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Need to read repo for checkout
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Check if Dependabot PR
        id: check-dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dependabot PR detected - skipping actual deployment"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy reason
        run: |
          if [[ "${{ needs.check-changes.outputs.force_deploy }}" == "true" ]]; then
            echo "üöÄ Deploying terminal service to DigitalOcean because force deploy was requested"
          elif [[ "${{ needs.check-changes.outputs.shared }}" == "true" ]]; then
            echo "üöÄ Deploying terminal service to DigitalOcean because shared configs changed"
          else
            echo "üöÄ Deploying terminal service to DigitalOcean because terminal files changed"
          fi

      - name: Trigger DigitalOcean Deployment
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: |
          # Same app ID - DigitalOcean deploys all components together
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/${{ secrets.DIGITALOCEAN_APP_ID }}/deployments
      
      - name: Wait for Deployment
        if: steps.check-dependabot.outputs.is_dependabot != 'true'
        run: |
          echo "‚è≥ Waiting for DigitalOcean deployment to complete..."
          sleep 180
          echo "‚úÖ Terminal service deployment triggered. Check DigitalOcean dashboard."
      
      - name: Dependabot PR Check Passed
        if: steps.check-dependabot.outputs.is_dependabot == 'true'
        run: |
          echo "‚úÖ Dependabot PR validated - deployment skipped intentionally"
          echo "This PR can be safely merged if all other checks pass"